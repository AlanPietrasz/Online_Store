<!-- shop.ejs -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="shopstyle.css" />
    <title>Shop</title>
    <script>
        function deleteProduct(productId) {
          if (!confirm('Are you sure you want to delete this product?')) {
            return;
          }
        
          fetch('/deleteProduct', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ productId: productId })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            document.getElementById('product_' + productId).remove();
          })
          .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
          });
        }
        </script>
<script>
    // ... other script code ...
  
    function toggleCartItem(productId, button) {
      const quantityInput = document.getElementById('quantity_' + productId);
      const quantity = parseInt(quantityInput.value, 10);
      // If the quantity is not a number or less than 1, we don't proceed
      if (isNaN(quantity) || quantity < 1) {
        alert('Please enter a valid quantity.');
        return;
      }
  
      const action = button.classList.contains('in-cart') ? 'removeFromCart' : 'addToCart';
      const requestBody = { productId: productId, quantity: quantity };
  
      fetch(`/${action}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // If you're using CSRF protection, make sure to add your token here
        },
        body: JSON.stringify(requestBody)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json(); // You can send back some JSON data from the server if needed
      })
      .then(data => {
        // Toggle the button appearance and state
        if (action === 'removeFromCart') {
          button.classList.remove('in-cart');
          button.textContent = 'Add to Cart';
        } else {
          button.classList.add('in-cart');
          button.textContent = 'Remove from Cart';
        }
      })
      .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
      });
    }
  </script>
  
        
        
</head>

<body>
    <div class="header">
        <h1>Shop</h1>
    </div>

    <%- include('navigationbar', locals.user ) %>

    <% if (locals.error) { %>
        <div class="alert alert-danger">
            <%= locals.error %>
        </div>
    <% } %>

    <form action="/shop" method="get">
        <input type="text" name="searchTerm" placeholder="Search products..." value="<%= searchTerm || '' %>" />
        <select name="orderBy">
            <option value="productName" <%= orderBy === 'productName' ? 'selected' : '' %>>Product Name</option>
            <option value="price" <%= orderBy === 'price' ? 'selected' : '' %>>Price</option>
        </select>
        <select name="direction">
            <option value="ASC" <%= direction === 'ASC' ? 'selected' : '' %>>Ascending</option>
            <option value="DESC" <%= direction === 'DESC' ? 'selected' : '' %>>Descending</option>
        </select>
        <select name="pageSize">
            <option value="2" <%= pageSize === 2 ? 'selected' : '' %>>2 per page</option>
            <option value="5" <%= pageSize === 5 ? 'selected' : '' %>>5 per page</option>
            <option value="10" <%= pageSize === 10 ? 'selected' : '' %>>10 per page</option>
            <option value="20" <%= pageSize === 20 ? 'selected' : '' %>>20 per page</option>
            <option value="30" <%= pageSize === 30 ? 'selected' : '' %>>30 per page</option>
            <option value="40" <%= pageSize === 40 ? 'selected' : '' %>>40 per page</option>
            <option value="50" <%= pageSize === 50 ? 'selected' : '' %>>50 per page</option>
        </select>
        <button type="submit">Search and Sort Products</button>
    </form>
    
    <div class="products">
        <% products.forEach(function(product) { %>
            <% if (userRoles.includes('admin') || (product.quantity !== 0 && product.price !== null)) { %>
                <div class="product" id="product_<%= product.ID %>">
                    <h2><%= product.productName %></h2>
                    <p><%= product.description %></p>
                    <div class="info-container">
                    <% if (product.price === 0) { %>
                        <p class="price price-free">Price: Free</p>
                    <% } else if (product.price === null) { %>
                        <p class="price price-not-available">Price: Not yet available for purchase</p>
                    <% } else { %>
                        <p class="price">Price: $<%= product.price.toFixed(2) %></p>
                    <% } %>

                    <% if (product.quantity === 0) { %>
                        <p class="quantity quantity-not-available">Not available</p>
                    <% } else if (product.quantity === null) { %>
                        <p class="quantity quantity-unlimited">Unlimited quantity</p>
                    <% } else { %>
                        <p class="quantity">Quantity: <%= product.quantity %></p>
                    <% } %>

                    <% if (userRoles.includes('user') && product.quantity !== 0) { %>
                        <form action="/addToCart" method="post">
                            <input type="hidden" name="productId" value="<%= product.ID %>">
                            <!-- <input type="number" name="quantity" value="1" min="1"> -->
                            <input type="number" id="quantity_<%= product.ID %>" name="quantity" value="1" min="1" class="quantity-input">
                            <button type="button" id="addToCart_<%= product.ID %>" onclick="toggleCartItem(<%= product.ID %>, this)" class="add-to-cart-button">Add to Cart</button>
                        </form>
                    <% } %>
                    </div>
                    <% if (userRoles.includes('admin')) { %>
                        <form action="/editProduct" method="get">
                            <input type="hidden" name="productId" value="<%= product.ID %>">
                            <button type="submit">Edit</button>
                        </form>
                        
                        <form action="/deleteProduct" method="post">
                            <input type="hidden" name="productId" value="<%= product.ID %>">
                            <input type="hidden" name="searchTerm" value="<%= searchTerm %>">
                            <input type="hidden" name="orderBy" value="<%= orderBy %>">
                            <input type="hidden" name="direction" value="<%= direction %>">
                            <input type="hidden" name="pageSize" value="<%= pageSize %>">
                            <input type="hidden" name="page" value="<%= page %>">                        
                            <button type="button" onclick="deleteProduct(<%= product.ID %>)">Delete</button>
                        </form>
                    <% } %>
                </div>
            <% } %>
        <% }); %>
    </div>

    <div class="pagination">
        <% for(let i = 1; i <= totalPages; i++) { %>
            <a href="/shop?page=<%= i %>&orderBy=<%= orderBy %>&direction=<%= direction %>&pageSize=<%= pageSize %>"
            class="<%= page == i ? 'active' : '' %>"><%= i %></a>
        <% } %>
    </div>

</body>

</html>